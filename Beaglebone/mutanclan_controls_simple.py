import threading
import serial
import time
from Adafruit_PWM_Servo_Driver import PWM


controller = [100,100,0,100,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
motor = [0,0,0,0]                       # front left, front right, back left, back right
compressor = 0


class xbee(threading.Thread):
    def __init__ (self):
        threading.Thread.__init__(self)
    def run(self):
        global controller
        packet = [0,0,0,0,0,0,0,0]
        baudrate = 57600
        
        xbee = serial.Serial('/dev/ttyO2', baudrate) # Use UART2 serial port
        
        while True:
            if(int(xbee.read().encode('hex'),16) == 255):
                for i in range(0,8):
                    packet[i] = int(xbee.read().encode('hex'),16)
                if(int(xbee.read().encode('hex'),16) == 254):
                    controller[18] = (packet[0] & 1) >> 0       #start
                    controller[17] = (packet[0] & 2) >> 1       #RB
                    controller[16] = (packet[0] & 4) >> 2       #LB
                    controller[ 9] = (packet[0] & 8) >> 3       #Y
                    controller[ 8] = (packet[0] & 16) >> 4      #X
                    controller[ 7] = (packet[0] & 32) >> 5      #B
                    controller[ 6] = (packet[0] & 64) >> 6      #A
                    
                    controller[19] = (packet[1] & 1) >> 0       #back
                    controller[ 5] = (packet[1] & 2) >> 1       #RC
                    controller[ 2] = (packet[1] & 4) >> 2       #LC
                    controller[13] = (packet[1] & 8) >> 3       #DR
                    controller[12] = (packet[1] & 16) >> 4      #DL
                    controller[11] = (packet[1] & 32) >> 5      #DD
                    controller[10] = (packet[1] & 64) >> 6      #DU
                    
                    controller[ 0] = packet[2]                  #LSX
                    controller[ 1] = packet[3]                  #LSY
                    controller[ 3] = packet[4]                  #RSX
                    controller[ 4] = packet[5]                  #RSY
                    controller[14] = packet[6]                  #LT
                    controller[15] = packet[7]                  #RT
            
            while(xbee.inWaiting() > 10):
                xbee.read()


class processing(threading.Thread):
    def __init__ (self):
        threading.Thread.__init__(self)
    def run(self):
        global motor
        global compressor
        stick_tolerance = 0.01
        deadzone_top = 350
        deadzone_bottom = 310
        scale = 150

        past_button = 0
        
        while True:
            if(controller[6] == 1 && past_button == 0)
                if(compressor == 0)
                    compressor = 1
                else(compressor == 1)
                    compressor = 0
                past_button = 1
            if(controller[6] == 0)
                past_button = 0

            LSX = ((controller[0]-100)/300)*scale
            LSY = ((controller[1]-100)/300)*scale
            RSX = ((controller[3]-100)/300)*scale

            if(LSY + LSX + RSX > stick_tolerance)
                motor[0] = LSY + LSX + RSX + deadzone_top
            else if(LSY + LSX + RSX < -stick_tolerance)
                motor[0] = LSY + LSX + RSX + deadzone_bottom

            if(LSY - LSX - RSX > stick_tolerance)
                motor[1] = LSY - LSX - RSX + deadzone_top
            else if(LSY - LSX - RSX < -stick_tolerance)
                motor[1] = LSY - LSX - RSX + deadzone_bottom

            if(LSY - LSX + RSX > stick_tolerance)
                motor[2] = LSY - LSX + RSX + deadzone_top
            else if(LSY - LSX + RSX < -stick_tolerance)
                motor[2] = LSY - LSX + RSX + deadzone_bottom

            if(LSY + LSX - RSX > stick_tolerance)
                motor[3] = LSY + LSX - RSX + deadzone_top
            else if(LSY + LSX - RSX < -stick_tolerance)
                motor[3] = LSY + LSX - RSX + deadzone_bottom

            time.sleep(0.01)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        


class motors(threading.Thread):
    def __init__ (self):
        threading.Thread.__init__(self)
    def run(self):
        pwm = PWM(0x40, debug=True)
        pwm.setPWMFreq(60)              # Set frequency to 60 Hz
        
        while True:
            for i in range (0,4):
                pwm.setPWM(2*i, 0, motor[i])
            time.sleep(0.01)


thread_xbee = xbee()
thread_processing = processing()
thread_motors = motors()

thread_xbee.start()
thread_processing.start()
thread_motors.start()